pipeline {
    agent any

    stages {

        stage('Backup Jenkins Credentials Metadata') {
            steps {
                script {
                    echo "Starting secure credentials backup..."

                    // Ensure backup directory exists
                    sh '''
                    mkdir -p $JENKINS_HOME/backups
                    BACKUP_FILE="$JENKINS_HOME/backups/credentials_backup_$(date +%Y%m%d_%H%M%S).xml"
                    echo "Creating masked credentials metadata backup at: $BACKUP_FILE"

                    # Copy credentials.xml safely (contains encrypted secrets)
                    cp $JENKINS_HOME/credentials.xml "$BACKUP_FILE"

                    echo "Backup created successfully (encrypted credentials only)."
                    '''
                }
            }
        }

        stage('Mask Sensitive Data in Log') {
            steps {
                script {
                    echo "No sensitive data printed to logs."
                    echo "Secrets remain encrypted and safe in the backup file."
                }
            }
        }

        stage('Optional: Verify Backup') {
            steps {
                script {
                    sh '''
                    echo "Verifying backup file exists..."
                    ls -lh $JENKINS_HOME/backups/credentials_backup_*.xml || echo "No backups found!"
                    '''
                }
            }
        }
    }

    post {
        success {
            echo "✅ Jenkins credentials metadata backup completed successfully."
        }
        failure {
            echo "❌ Backup failed. Please check Jenkins logs for details."
        }
    }
}
